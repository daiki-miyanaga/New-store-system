<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Áô∫Ê≥®‰øÆÊ≠£„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ | Âú®Â∫´ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É† - MOC Architecture</title>
    
    <!-- MOC Base Styles -->
    <link rel="stylesheet" href="assets/css/base.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <link rel="stylesheet" href="assets/css/dashboard.css">
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîÑ</text></svg>">
    
    <style>
    /* Order SimulationÂ∞ÇÁî®„Çπ„Çø„Ç§„É´ */
    .order-simulation-layout {
        min-height: 100vh;
        background-color: var(--bg-secondary);
    }

    .order-main {
        flex: 1;
        padding-top: 0;
    }

    .order-content {
        padding-bottom: var(--spacing-3xl);
    }

    .budget-control,
    .data-sync,
    .order-products,
    .composition-analysis,
    .order-summary,
    .inventory-forecast,
    .order-actions {
        padding: var(--spacing-xl) 0;
        border-bottom: 1px solid var(--border-color);
    }

    .order-actions {
        border-bottom: none;
    }

    /* Budget Cards */
    .budget-cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    .budget-edit-input {
        width: 100%;
        font-size: inherit;
        text-align: center;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-md);
        padding: var(--spacing-xs);
    }

    /* Data Sync Panel */
    .sync-panel {
        background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
        padding: var(--spacing-xl);
        border-radius: var(--border-radius-lg);
        border: 1px solid var(--border-color);
        text-align: center;
        box-shadow: var(--shadow-md);
    }

    .sync-panel h3 {
        margin-bottom: var(--spacing-md);
        color: var(--text-primary);
    }

    .sync-panel p {
        color: var(--text-secondary);
        margin-bottom: var(--spacing-lg);
    }

    /* Order Controls */
    .order-controls {
        display: flex;
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
        flex-wrap: wrap;
    }

    .control-item {
        display: flex;
        flex-direction: column;
        min-width: 200px;
    }

    .control-item label {
        font-weight: var(--font-weight-semibold);
        color: var(--text-secondary);
        margin-bottom: var(--spacing-xs);
        font-size: var(--font-size-sm);
    }

    .form-input {
        padding: var(--spacing-sm);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-md);
        font-size: var(--font-size-base);
        transition: border-color var(--transition-fast);
    }

    .form-input:focus {
        outline: none;
        border-color: var(--color-secondary);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    /* Order Table */
    .order-table {
        width: 100%;
        background: var(--bg-primary);
        border-radius: var(--border-radius-lg);
        overflow: hidden;
        box-shadow: var(--shadow-lg);
    }

    /* Composition Slider */
    .composition-slider {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: var(--color-gray-200);
        outline: none;
        margin-bottom: var(--spacing-xs);
    }

    .composition-slider::-webkit-slider-thumb {
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--color-secondary);
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .composition-slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: var(--color-secondary);
        cursor: pointer;
        border: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .composition-value {
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-semibold);
        color: var(--color-secondary);
        display: block;
        text-align: center;
    }

    /* Constraints */
    .constraint-ok {
        color: var(--color-success);
        background: var(--color-success-light);
        padding: 2px 6px;
        border-radius: var(--border-radius-sm);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-semibold);
    }

    .constraint-warning {
        color: var(--color-warning-dark);
        background: var(--color-warning-light);
        padding: 2px 6px;
        border-radius: var(--border-radius-sm);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-semibold);
    }

    .constraint-error {
        color: var(--color-error-dark);
        background: var(--color-error-light);
        padding: 2px 6px;
        border-radius: var(--border-radius-sm);
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-semibold);
    }

    /* Chart Container */
    .chart-container {
        background: var(--bg-primary);
        border-radius: var(--border-radius-xl);
        padding: var(--spacing-xl);
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--border-color);
        height: 400px;
    }

    /* Summary Cards */
    .summary-cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-xl);
    }

    /* Forecast Panel */
    .forecast-panel {
        background: var(--bg-primary);
        padding: var(--spacing-xl);
        border-radius: var(--border-radius-lg);
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-md);
    }

    .forecast-item {
        margin-bottom: var(--spacing-lg);
    }

    .forecast-item h4 {
        margin-bottom: var(--spacing-sm);
        color: var(--text-primary);
        font-size: var(--font-size-lg);
    }

    .forecast-results {
        padding: var(--spacing-lg);
        background: var(--color-gray-50);
        border-radius: var(--border-radius-md);
        border: 1px solid var(--border-color);
    }

    .forecast-result h5 {
        margin-bottom: var(--spacing-md);
        color: var(--text-primary);
        text-align: center;
    }

    .forecast-step {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-sm) 0;
        border-bottom: 1px solid var(--border-color);
    }

    .forecast-step:last-child {
        border-bottom: none;
    }

    .forecast-step span {
        color: var(--text-secondary);
    }

    .forecast-step strong {
        color: var(--text-primary);
        font-weight: var(--font-weight-semibold);
    }

    /* Action Bar */
    .actions-bar {
        display: flex;
        gap: var(--spacing-md);
        justify-content: center;
        flex-wrap: wrap;
    }

    .btn {
        padding: var(--spacing-md) var(--spacing-lg);
        border: none;
        border-radius: var(--border-radius-lg);
        font-size: var(--font-size-base);
        font-weight: var(--font-weight-semibold);
        cursor: pointer;
        transition: all var(--transition-base);
        display: inline-flex;
        align-items: center;
        gap: var(--spacing-xs);
        text-decoration: none;
        min-width: 160px;
        justify-content: center;
    }

    .btn-primary {
        background-color: var(--color-secondary);
        color: var(--color-white);
    }

    .btn-primary:hover {
        background-color: var(--color-secondary-dark);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .btn-secondary {
        background-color: var(--color-gray-100);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
        background-color: var(--color-gray-200);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .btn-warning {
        background-color: var(--color-warning);
        color: var(--color-white);
    }

    .btn-warning:hover {
        background-color: var(--color-warning-dark);
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
        box-shadow: none !important;
    }

    /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
    @media (max-width: 768px) {
        .budget-cards-grid,
        .summary-cards-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
        }

        .order-controls {
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .control-item {
            min-width: auto;
        }

        .actions-bar {
            flex-direction: column;
            align-items: center;
        }

        .btn {
            width: 100%;
            max-width: 280px;
        }

        .chart-container {
            height: 300px;
            padding: var(--spacing-md);
        }
    }

    @media (max-width: 480px) {
        .budget-cards-grid,
        .summary-cards-grid {
            grid-template-columns: 1fr;
        }

        .budget-control,
        .data-sync,
        .order-products,
        .composition-analysis,
        .order-summary,
        .inventory-forecast,
        .order-actions {
            padding: var(--spacing-md) 0;
        }

        .sync-panel {
            padding: var(--spacing-lg);
        }

        .forecast-panel {
            padding: var(--spacing-lg);
        }
    }

    /* Animation */
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .budget-control,
    .data-sync,
    .order-products,
    .composition-analysis,
    .order-summary,
    .inventory-forecast {
        animation: slideInUp 0.6s ease-out;
    }

    .budget-control { animation-delay: 0.1s; }
    .data-sync { animation-delay: 0.2s; }
    .order-products { animation-delay: 0.3s; }
    .composition-analysis { animation-delay: 0.4s; }
    .order-summary { animation-delay: 0.5s; }
    .inventory-forecast { animation-delay: 0.6s; }
    </style>
</head>
<body>
    <!-- Order Simulation will be mounted here -->
    <div id="order-root"></div>
    
    <!-- Loading indicator -->
    <div id="order-loading" class="dashboard-loading" style="display: none;">
        <div class="dashboard-loading-spinner"></div>
        <div class="dashboard-loading-text">Áô∫Ê≥®„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
    </div>
    
    <!-- Error state -->
    <div id="order-error" class="dashboard-error" style="display: none;">
        <div class="dashboard-error-icon">‚ö†Ô∏è</div>
        <div class="dashboard-error-message">Áô∫Ê≥®„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>
        <button class="dashboard-retry-btn" onclick="initializeOrderSimulation()">ÂÜçË©¶Ë°å</button>
    </div>
    
    <!-- Calculation indicator -->
    <div id="calculation-indicator" class="dashboard-refresh-indicator">
        üßÆ Áô∫Ê≥®Êï∞„ÇíË®àÁÆó‰∏≠...
    </div>
    
    <!-- MOC Core Components -->
    <script src="src/utils/EventBus.js"></script>
    <script src="src/stores/AppStore.js"></script>
    <script src="src/services/InventoryService.js"></script>
    
    <!-- MOC UI Components -->
    <script src="src/components/ui/Card.js"></script>
    <script src="src/components/ui/Table.js"></script>
    <script src="src/components/ui/Chart.js"></script>
    <script src="src/components/ui/Alert.js"></script>
    <script src="src/components/ui/Form.js"></script>
    
    <!-- MOC Layout Components -->
    <script src="src/components/layout/Header.js"></script>
    
    <!-- MOC Order Simulation Page -->
    <script src="src/pages/order/OrderSimulation.js"></script>
    
    <script>
        // Global application state
        let orderSimulation = null;
        let isLoading = false;
        
        /**
         * Áô∫Ê≥®„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„ÅÆÂàùÊúüÂåñ
         */
        async function initializeOrderSimulation() {
            if (isLoading) return;
            
            try {
                isLoading = true;
                showLoading();
                
                // OrderSimulation instance creation
                orderSimulation = new OrderSimulation({
                    container: '#order-root',
                    autoCalculate: true,
                    maxBudget: 180000
                });
                
                // Initialize order simulation system
                await orderSimulation.init();
                
                hideLoading();
                
                // Setup global event listeners
                setupGlobalEventListeners();
                
                // Debug information
                console.log('üöÄ MOC Order Simulation initialized successfully');
                console.log('üìä Components loaded:', {
                    EventBus: !!window.eventBus,
                    AppStore: !!window.appStore,
                    Card: !!window.Card,
                    Table: !!window.Table,
                    Chart: !!window.MOCChart,
                    Alert: !!window.Alert,
                    Form: !!window.Form,
                    Header: !!window.Header,
                    OrderSimulation: !!window.OrderSimulation
                });
                
            } catch (error) {
                console.error('Order Simulation initialization failed:', error);
                showError();
            } finally {
                isLoading = false;
            }
        }
        
        /**
         * „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
         */
        function showLoading() {
            document.getElementById('order-loading').style.display = 'flex';
            document.getElementById('order-error').style.display = 'none';
            document.getElementById('order-root').style.display = 'none';
        }
        
        /**
         * „É≠„Éº„Éá„Ç£„É≥„Ç∞ÈùûË°®Á§∫
         */
        function hideLoading() {
            document.getElementById('order-loading').style.display = 'none';
            document.getElementById('order-root').style.display = 'block';
        }
        
        /**
         * „Ç®„É©„ÉºË°®Á§∫
         */
        function showError() {
            document.getElementById('order-loading').style.display = 'none';
            document.getElementById('order-error').style.display = 'flex';
            document.getElementById('order-root').style.display = 'none';
        }
        
        /**
         * Ë®àÁÆó„Ç§„É≥„Ç∏„Ç±„Éº„Çø„ÉºË°®Á§∫
         */
        function showCalculationIndicator() {
            const indicator = document.getElementById('calculation-indicator');
            indicator.classList.add('show');
            
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 1500);
        }
        
        /**
         * „Ç∞„É≠„Éº„Éê„É´„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
         */
        function setupGlobalEventListeners() {
            // Order events
            if (window.eventBus) {
                window.eventBus.on('order.productUpdated', (data) => {
                    console.log('üõí Order product updated:', data.column, data.value);
                    showCalculationIndicator();
                });
                
                window.eventBus.on('order.budgetUpdated', (data) => {
                    console.log('üí∞ Budget updated:', data.budgetKey, data.value);
                });
                
                window.eventBus.on('order.requestPerformanceData', () => {
                    console.log('üìä Performance data requested for sync');
                });
                
                // Performance system integration
                window.eventBus.on('performance.syncToOrder', (data) => {
                    console.log('üîÑ Received performance data for sync:', data);
                    if (orderSimulation) {
                        // Update order simulation with performance data
                        Alert.success('ÂÆüÁ∏æ„Éá„Éº„Çø„ÇíÂêåÊúü„Åó„Åæ„Åó„Åü').mount();
                    }
                });
            }
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Ctrl/Cmd + Enter for calculate orders
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    if (orderSimulation) {
                        orderSimulation.calculateOrders();
                    }
                }
                
                // Ctrl/Cmd + S for save order data
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    if (orderSimulation) {
                        orderSimulation.saveOrderData();
                    }
                }
                
                // Ctrl/Cmd + E for export
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    e.preventDefault();
                    if (orderSimulation) {
                        orderSimulation.exportOrderData();
                    }
                }
                
                // F5 for full reload
                if (e.key === 'F5') {
                    e.preventDefault();
                    location.reload();
                }
            });
            
            // Performance monitoring
            if (window.performance && window.performance.mark) {
                window.performance.mark('order-simulation-ready');
            }
            
            // Page visibility change handling
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && orderSimulation) {
                    console.log('üëÄ Order simulation page became visible');
                }
            });
        }
        
        /**
         * ÊßãÊàêÊØîÂ§âÊõ¥„Éè„É≥„Éâ„É™„É≥„Ç∞Ôºà„Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞Ôºâ
         */
        window.handleCompositionChange = function(code, value) {
            console.log('üéØ Composition changed:', code, value);
            
            if (orderSimulation && orderSimulation.orderData) {
                const product = orderSimulation.orderData.find(p => p.code === code);
                if (product) {
                    product.composition = parseFloat(value);
                    
                    // Áô∫Ê≥®Êï∞„Å®ÈáëÈ°ç„ÇíÂÜçË®àÁÆó
                    const budget = orderSimulation.getBudgetForDay(
                        document.getElementById('target-day')?.value || 'today'
                    );
                    const allocatedAmount = (budget * product.composition) / 100;
                    product.quantity = Math.floor(allocatedAmount / product.price);
                    product.amount = product.quantity * product.price;
                    
                    // UIÊõ¥Êñ∞
                    orderSimulation.updateSummaryCards();
                    orderSimulation.updateCompositionChart();
                    
                    // „Ç§„Éô„É≥„ÉàÁô∫ÁÅ´
                    if (window.eventBus) {
                        window.eventBus.emit('order.productUpdated', {
                            row: product,
                            column: 'composition',
                            value: product.composition
                        });
                    }
                }
            }
        };
        
        /**
         * „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„ÅÆÂàùÊúüÂåñ
         */
        document.addEventListener('DOMContentLoaded', () => {
            // Performance timing
            const startTime = performance.now();
            
            // Initialize application
            initializeOrderSimulation().then(() => {
                const endTime = performance.now();
                console.log(`‚ö° Order Simulation loaded in ${(endTime - startTime).toFixed(2)}ms`);
                
                // Welcome message for development
                if (window.location.search.includes('debug=true')) {
                    Alert.success('üéâ MOC Order Simulation loaded successfully!', {
                        autoClose: 3000
                    }).mount();
                }
            });
        });
        
        /**
         * Error handling
         */
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
            
            if (window.Alert) {
                Alert.error('‰∫àÊúü„Åó„Å™„ÅÑ„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ„Éá„Éº„Çø„Çí‰øùÂ≠ò„Åó„Å¶„Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ').mount();
            }
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            console.error('Unhandled promise rejection:', e.reason);
            e.preventDefault();
        });
        
        // Export for debugging
        if (window.location.search.includes('debug=true')) {
            window.orderSimulation = null; // Will be set after initialization
            window.mocOrderDebug = {
                calculateOrders: () => orderSimulation?.calculateOrders(),
                optimizeOrders: () => orderSimulation?.optimizeOrders(),
                saveOrderData: () => orderSimulation?.saveOrderData(),
                exportOrderData: () => orderSimulation?.exportOrderData(),
                resetOrders: () => orderSimulation?.resetOrders(),
                syncPerformanceData: () => orderSimulation?.syncPerformanceData(),
                getBudgetData: () => orderSimulation?.budgetData,
                getOrderData: () => orderSimulation?.orderData,
                showTestAlert: () => Alert.success('Test alert from Order Simulation').mount(),
                getStats: () => ({
                    eventBusStats: window.eventBus?.getStats(),
                    appStoreDebug: window.appStore?.getDebugInfo(),
                    totalBudget: Object.values(orderSimulation?.budgetData || {}).reduce((sum, val) => sum + val, 0),
                    totalProducts: orderSimulation?.orderData?.length || 0
                })
            };
            
            console.log('üîß Debug mode enabled. Use window.mocOrderDebug for debugging.');
        }
    </script>
    
    <!-- Service Worker registration for offline support (optional) -->
    <script>
        if ('serviceWorker' in navigator && window.location.protocol === 'https:') {
            navigator.serviceWorker.register('/sw.js').then((registration) => {
                console.log('SW registered: ', registration);
            }).catch((registrationError) => {
                console.log('SW registration failed: ', registrationError);
            });
        }
    </script>
</body>
</html>