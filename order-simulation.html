<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>発注修正シミュレーション</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.5rem;
        }
        
        .back-btn {
            background: #3498db;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
        }
        
        .back-btn:hover {
            background: #2980b9;
        }
        
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        
        .simulation-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .form-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 2rem;
        }
        
        .form-section h2 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 1rem;
        }
        
        .form-group label {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }
        
        .form-group input,
        .form-group select {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .order-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .order-table th,
        .order-table td {
            padding: 0.75rem;
            text-align: center;
            border: 1px solid #ddd;
        }
        
        .order-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .order-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .order-input {
            width: 80px;
            padding: 0.3rem;
            border: 1px solid #3498db;
            border-radius: 4px;
            text-align: center;
        }
        
        .current-order {
            background-color: #e8f5e8;
        }
        
        .modified-order {
            background-color: #fff3cd;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
            margin-right: 1rem;
            margin-bottom: 1rem;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #219a52;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #d68910;
        }
        
        .simulation-results {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-top: 2rem;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .result-card {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
            border-left: 4px solid #3498db;
        }
        
        .result-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .result-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 0.5rem;
        }
        
        .change-positive {
            color: #27ae60;
        }
        
        .change-negative {
            color: #e74c3c;
        }
        
        .scenario-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .tab-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .tab-btn.active {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }
        
        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
        }
        
        .alert-info {
            background: #d1ecf1;
            border: 1px solid #17a2b8;
            color: #0c5460;
        }
        
        /* スライダー調整パネル */
        .slider-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .slider-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .slider-item label {
            min-width: 120px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .slider-item input[type="range"] {
            flex: 1;
            margin: 0 1rem;
        }
        
        .slider-value {
            min-width: 80px;
            text-align: center;
            font-weight: bold;
            color: #3498db;
        }
        
        /* 複数日予算制御 */
        .multi-day-budget {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .multi-day-budget h2 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .budget-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        
        .budget-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            position: relative;
        }
        
        .budget-date {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #f8f9fa;
        }
        
        .budget-limit {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        
        .budget-input-group {
            margin-bottom: 1rem;
        }
        
        .budget-input-group label {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            color: #f8f9fa;
        }
        
        .budget-input-group input {
            width: 100%;
            padding: 0.5rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            text-align: center;
        }
        
        .budget-progress {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .budget-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #f39c12, #e74c3c);
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .budget-current {
            font-size: 0.9rem;
            color: #f8f9fa;
        }
        
        /* 在庫推移予測 */
        .inventory-forecast {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        .forecast-controls .form-group {
            margin-bottom: 1.5rem;
        }
        
        .forecast-controls label {
            display: block;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }
        
        .forecast-controls input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .forecast-controls small {
            display: block;
            margin-top: 0.25rem;
            color: #6c757d;
            font-size: 0.8rem;
        }
        
        .forecast-results {
            padding: 1rem;
        }
        
        .forecast-results h4 {
            margin-bottom: 1rem;
            color: #2c3e50;
        }
        
        /* 個別商品調整パネル */
        .product-adjustment-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
        }
        
        .sync-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #dee2e6;
        }
        
        .sync-status {
            flex: 1;
            padding: 0.5rem 1rem;
            background: white;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            font-size: 0.9rem;
        }
        
        .individual-products {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .product-item {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            display: grid;
            grid-template-columns: 200px 120px 1fr 120px;
            gap: 1rem;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .product-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .product-name {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .product-price {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .product-stock {
            text-align: center;
        }
        
        .stock-value {
            font-weight: bold;
            color: #e74c3c;
            font-size: 1.1rem;
        }
        
        .product-slider {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .product-slider label {
            min-width: 60px;
            font-size: 0.9rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .product-slider input[type="range"] {
            flex: 1;
        }
        
        .order-value {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
            color: #3498db;
        }
        
        .product-amount {
            text-align: center;
            font-weight: bold;
            color: #27ae60;
            font-size: 1.1rem;
        }
        
        .adjustment-summary {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            text-align: center;
        }
        
        .summary-item {
            padding: 0.5rem;
            border-radius: 4px;
            background: #f8f9fa;
        }
        
        /* チャートコンテナ */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .chart-box {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
        }
        
        .chart-box h3 {
            margin-bottom: 1rem;
            color: #2c3e50;
            text-align: center;
        }
        
        /* 構成比テーブル */
        .composition-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .composition-table th,
        .composition-table td {
            padding: 0.5rem;
            text-align: center;
            border-bottom: 1px solid #ddd;
            font-size: 0.9rem;
        }
        
        .composition-table th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #2c3e50;
        }
        
        /* 制約バッジ */
        .constraint-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }
        
        .constraint-ok {
            background: #d4edda;
            color: #155724;
        }
        
        .constraint-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .constraint-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* レスポンシブデザイン */
        @media (max-width: 1200px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
                margin: 1rem auto;
            }
            
            .header {
                padding: 0.75rem 1rem;
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
            }
            
            .simulation-panel {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .budget-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .inventory-forecast {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .product-item {
                grid-template-columns: 1fr;
                gap: 0.75rem;
                text-align: center;
            }
            
            .sync-controls {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .slider-item {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }
            
            .slider-item label {
                min-width: auto;
                text-align: center;
            }
            
            .slider-value {
                text-align: center;
            }
            
            .order-table {
                font-size: 0.8rem;
            }
            
            .order-table th,
            .order-table td {
                padding: 0.3rem;
            }
            
            .results-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .result-card {
                padding: 1rem;
            }
            
            .result-value {
                font-size: 1.2rem;
            }
        }
        
        @media (max-width: 480px) {
            .scenario-tabs {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .tab-btn {
                width: 100%;
                text-align: center;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .order-table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
        }
        
        /* アクセシビリティ向上 */
        .tab-btn:focus,
        .btn:focus {
            outline: 3px solid #3498db;
            outline-offset: 2px;
        }
        
        .order-input:focus {
            outline: 2px solid #3498db;
            outline-offset: 1px;
        }
        
        /* 高コントラストモード対応 */
        @media (prefers-contrast: high) {
            .form-section {
                border: 1px solid #2c3e50;
            }
            
            .slider-panel {
                border: 1px solid #7f8c8d;
            }
            
            .budget-card {
                border: 2px solid #2c3e50;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🔄 発注修正シミュレーション</h1>
        <a href="index.html" class="back-btn">← メインメニュー</a>
    </div>
    
    <div class="container">
        <div class="simulation-panel">
            <!-- 条件設定 -->
            <div class="form-section">
                <h2>⚙️ シミュレーション条件</h2>
                <div class="form-group">
                    <label>シミュレーション期間</label>
                    <select>
                        <option>1日</option>
                        <option>2日</option>
                        <option>3日</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>基準日</label>
                    <input type="date" value="2024-01-15">
                </div>
                <div class="form-group">
                    <label>参考日付</label>
                    <input type="date" value="2024-01-08">
                </div>
                <div class="form-group">
                    <label>前年同日</label>
                    <input type="date" value="2023-01-15">
                </div>
                <div class="form-group">
                    <label>店舗</label>
                    <select>
                        <option>全店舗</option>
                        <option>本店</option>
                        <option>支店A</option>
                        <option>支店B</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>想定売上変動率（%）</label>
                    <input type="number" value="0" placeholder="±0">
                </div>
                <div class="form-group">
                    <label>季節要因</label>
                    <select>
                        <option>通常期</option>
                        <option>イベント期</option>
                        <option>閑散期</option>
                        <option>繁忙期</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>前年気温補正</label>
                    <select>
                        <option>補正なし</option>
                        <option>気温差考慮</option>
                        <option>季節トレンド</option>
                    </select>
                </div>
            </div>
            
            <!-- シナリオ選択 -->
            <div class="form-section">
                <h2>📋 シナリオ選択</h2>
                <div class="scenario-tabs">
                    <button class="tab-btn active">現在の発注</button>
                    <button class="tab-btn">参考日ベース</button>
                    <button class="tab-btn">前年同日ベース</button>
                    <button class="tab-btn">カスタム</button>
                </div>
                
                <div class="alert alert-info">
                    <strong>現在のシナリオ:</strong> 過去3日間の平均に基づく短期発注パターン<br>
                    <strong>参考日実績:</strong> 2024/01/08 売上¥58,200 (構成比差: ケーキ+2.3%)<br>
                    <strong>前年同日実績:</strong> 2023/01/15 売上¥52,100 (前年比+15.7%)
                </div>
                
                <button class="btn btn-primary">📊 シミュレーション実行</button>
                <button class="btn btn-success">💾 シナリオ保存</button>
                <button class="btn btn-warning">🔄 リセット</button>
            </div>
        </div>
        
        <!-- 複数日予算制御カード -->
        <div class="multi-day-budget">
            <h2>💰 複数日予算管理</h2>
            <div class="budget-grid">
                <div class="budget-card">
                    <div class="budget-date">本日 (8/19)</div>
                    <div class="budget-limit">¥60,000</div>
                    <div class="budget-progress">
                        <div class="budget-progress-bar" id="todayBudgetBar" style="width: 73%"></div>
                    </div>
                    <div class="budget-current">
                        現在: <span id="todayBudget">¥43,800</span> (73%)
                    </div>
                </div>
                
                <div class="budget-card">
                    <div class="budget-date">翌日 (8/20)</div>
                    <div class="budget-input-group">
                        <label>予算設定:</label>
                        <input type="number" id="tomorrowBudgetInput" value="65000" placeholder="65000" min="0" step="1000">
                    </div>
                    <div class="budget-progress">
                        <div class="budget-progress-bar" id="tomorrowBudgetBar" style="width: 0%"></div>
                    </div>
                    <div class="budget-current">
                        予想: <span id="tomorrowBudget">¥0</span> (0%)
                    </div>
                </div>
                
                <div class="budget-card">
                    <div class="budget-date">翌々日 (8/21)</div>
                    <div class="budget-input-group">
                        <label>予算設定:</label>
                        <input type="number" id="dayAfterBudgetInput" value="58000" placeholder="58000" min="0" step="1000">
                    </div>
                    <div class="budget-progress">
                        <div class="budget-progress-bar" id="dayAfterBudgetBar" style="width: 0%"></div>
                    </div>
                    <div class="budget-current">
                        自動修正: <span id="dayAfterBudget">¥0</span> (<span id="dayAfterPercentage">0</span>%)
                    </div>
                </div>
            </div>
        </div>

        <!-- 在庫推移と自動修正ロジック -->
        <div class="form-section">
            <h2>📊 在庫推移予測・自動修正</h2>
            <div class="inventory-forecast">
                <div class="forecast-controls">
                    <div class="form-group">
                        <label>当日残在庫入力:</label>
                        <input type="number" id="remainingStock" placeholder="例: 25" value="0" min="0">
                        <small>当日終了時の残在庫数を入力してください</small>
                    </div>
                    <div class="form-group">
                        <label>翌日予想売上数:</label>
                        <input type="number" id="tomorrowSales" placeholder="例: 120" value="100" min="0">
                        <small>翌日の予想販売数量</small>
                    </div>
                    <div class="form-group">
                        <label>翌々日予想売上数:</label>
                        <input type="number" id="dayAfterSales" placeholder="例: 110" value="95" min="0">
                        <small>翌々日の予想販売数量</small>
                    </div>
                </div>
                
                <div class="forecast-results">
                    <div class="alert alert-info">
                        <h4>📈 自動修正結果</h4>
                        <div id="autoAdjustmentResults">
                            当日残在庫を入力すると、翌々日の発注が自動調整されます。
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 実績入力連動・個別商品調整パネル -->
        <div class="form-section">
            <h2>🎛️ 個別商品発注数調整（実績入力連動）</h2>
            <div class="product-adjustment-panel">
                <div class="sync-controls">
                    <button id="syncFromPerformance" class="btn btn-success">📊 実績入力から在庫同期</button>
                    <div class="sync-status" id="syncStatus">
                        <span style="color: #6c757d;">実績入力ページのデータと同期してください</span>
                    </div>
                </div>
                
                <div class="individual-products">
                    <div class="product-item">
                        <div class="product-info">
                            <span class="product-name">ショートケーキ</span>
                            <span class="product-price">¥380</span>
                        </div>
                        <div class="product-stock">
                            <label>在庫:</label>
                            <span id="stock-YS001" class="stock-value">6</span>個
                        </div>
                        <div class="product-slider">
                            <label>発注数:</label>
                            <input type="range" id="orderSlider-YS001" min="0" max="50" value="35" step="1">
                            <span id="orderValue-YS001" class="order-value">35</span>個
                        </div>
                        <div class="product-amount">
                            ¥<span id="amount-YS001">13,300</span>
                        </div>
                    </div>
                    
                    <div class="product-item">
                        <div class="product-info">
                            <span class="product-name">チーズケーキ</span>
                            <span class="product-price">¥420</span>
                        </div>
                        <div class="product-stock">
                            <label>在庫:</label>
                            <span id="stock-YS002" class="stock-value">3</span>個
                        </div>
                        <div class="product-slider">
                            <label>発注数:</label>
                            <input type="range" id="orderSlider-YS002" min="0" max="50" value="18" step="1">
                            <span id="orderValue-YS002" class="order-value">18</span>個
                        </div>
                        <div class="product-amount">
                            ¥<span id="amount-YS002">7,560</span>
                        </div>
                    </div>
                    
                    <div class="product-item">
                        <div class="product-info">
                            <span class="product-name">フルーツタルト</span>
                            <span class="product-price">¥350</span>
                        </div>
                        <div class="product-stock">
                            <label>在庫:</label>
                            <span id="stock-YS003" class="stock-value">0</span>個
                        </div>
                        <div class="product-slider">
                            <label>発注数:</label>
                            <input type="range" id="orderSlider-YS003" min="0" max="50" value="20" step="1">
                            <span id="orderValue-YS003" class="order-value">20</span>個
                        </div>
                        <div class="product-amount">
                            ¥<span id="amount-YS003">7,000</span>
                        </div>
                    </div>
                    
                    <div class="product-item">
                        <div class="product-info">
                            <span class="product-name">チョコレートケーキ</span>
                            <span class="product-price">¥400</span>
                        </div>
                        <div class="product-stock">
                            <label>在庫:</label>
                            <span id="stock-YS004" class="stock-value">8</span>個
                        </div>
                        <div class="product-slider">
                            <label>発注数:</label>
                            <input type="range" id="orderSlider-YS004" min="0" max="50" value="22" step="1">
                            <span id="orderValue-YS004" class="order-value">22</span>個
                        </div>
                        <div class="product-amount">
                            ¥<span id="amount-YS004">8,800</span>
                        </div>
                    </div>
                    
                    <div class="product-item">
                        <div class="product-info">
                            <span class="product-name">モンブラン</span>
                            <span class="product-price">¥450</span>
                        </div>
                        <div class="product-stock">
                            <label>在庫:</label>
                            <span id="stock-YS005" class="stock-value">12</span>個
                        </div>
                        <div class="product-slider">
                            <label>発注数:</label>
                            <input type="range" id="orderSlider-YS005" min="0" max="50" value="15" step="1">
                            <span id="orderValue-YS005" class="order-value">15</span>個
                        </div>
                        <div class="product-amount">
                            ¥<span id="amount-YS005">6,750</span>
                        </div>
                    </div>
                </div>
                
                <div class="adjustment-summary">
                    <div class="summary-item">
                        <strong>合計発注数: <span id="totalOrderQuantity">110</span>個</strong>
                    </div>
                    <div class="summary-item">
                        <strong>合計金額: ¥<span id="totalOrderAmount">43,410</span></strong>
                    </div>
                    <div class="summary-item">
                        <strong>平均在庫充足率: <span id="averageStockRate">72%</span></strong>
                    </div>
                </div>
            </div>
        </div>

        <!-- 発注数量調整テーブル -->
        <div class="form-section">
            <h2>📦 発注数量調整</h2>
            <table class="order-table">
                <thead>
                    <tr>
                        <th>商品コード</th>
                        <th>商品名</th>
                        <th>カテゴリ</th>
                        <th>現在発注数</th>
                        <th>参考日実績</th>
                        <th>前年実績</th>
                        <th>修正発注数</th>
                        <th>構成比</th>
                        <th>差分</th>
                        <th>制約チェック</th>
                        <th>在庫時間</th>
                        <th>予想廃棄率</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>YS001</td>
                        <td>ショートケーキ</td>
                        <td>ケーキ</td>
                        <td class="current-order">30</td>
                        <td>33</td>
                        <td>28</td>
                        <td><input type="number" class="order-input" value="35" data-min="12" data-step="6"></td>
                        <td class="composition-cell">18.2%</td>
                        <td class="change-positive">+5</td>
                        <td><span class="constraint-badge constraint-warning">倍数外</span></td>
                        <td>18時間</td>
                        <td>5%</td>
                        <td><button class="btn btn-primary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">適用</button></td>
                    </tr>
                    <tr>
                        <td>YS002</td>
                        <td>チーズケーキ</td>
                        <td>ケーキ</td>
                        <td class="current-order">20</td>
                        <td>22</td>
                        <td>18</td>
                        <td><input type="number" class="order-input" value="18" data-min="6" data-step="3"></td>
                        <td class="composition-cell">9.4%</td>
                        <td class="change-negative">-2</td>
                        <td><span class="constraint-badge constraint-ok">OK</span></td>
                        <td>24時間</td>
                        <td>3%</td>
                        <td><button class="btn btn-primary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">適用</button></td>
                    </tr>
                    <tr>
                        <td>YS003</td>
                        <td>フルーツタルト</td>
                        <td>ケーキ</td>
                        <td class="current-order">15</td>
                        <td>18</td>
                        <td>12</td>
                        <td><input type="number" class="order-input" value="20" data-min="8" data-step="4"></td>
                        <td class="composition-cell">10.4%</td>
                        <td class="change-positive">+5</td>
                        <td><span class="constraint-badge constraint-ok">OK</span></td>
                        <td>14時間</td>
                        <td>8%</td>
                        <td><button class="btn btn-primary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">適用</button></td>
                    </tr>
                    <tr>
                        <td>YS004</td>
                        <td>チョコレートケーキ</td>
                        <td>ケーキ</td>
                        <td class="current-order">25</td>
                        <td>27</td>
                        <td>23</td>
                        <td><input type="number" class="order-input" value="22" data-min="10" data-step="2"></td>
                        <td class="composition-cell">11.5%</td>
                        <td class="change-negative">-3</td>
                        <td><span class="constraint-badge constraint-ok">OK</span></td>
                        <td>30時間</td>
                        <td>4%</td>
                        <td><button class="btn btn-primary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">適用</button></td>
                    </tr>
                    <tr>
                        <td>YS005</td>
                        <td>モンブラン</td>
                        <td>ケーキ</td>
                        <td class="current-order">12</td>
                        <td>14</td>
                        <td>10</td>
                        <td><input type="number" class="order-input" value="15" data-min="5" data-step="1"></td>
                        <td class="composition-cell">7.8%</td>
                        <td class="change-positive">+3</td>
                        <td><span class="constraint-badge constraint-ok">OK</span></td>
                        <td>22時間</td>
                        <td>6%</td>
                        <td><button class="btn btn-primary" style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">適用</button></td>
                    </tr>
                </tbody>
            </table>
            
            <div class="alert alert-warning">
                <strong>注意:</strong> フルーツタルトの在庫時間が短く、品切れリスクがあります。発注数量の増加を検討してください。
            </div>
        </div>
        
        <!-- シミュレーション結果 -->
        <div class="simulation-results">
            <h2>📈 シミュレーション結果</h2>
            <div class="results-grid">
                <div class="result-card">
                    <div class="result-value">¥2,450,000</div>
                    <div class="result-label">予想売上額</div>
                    <div class="change-positive">(+¥85,000)</div>
                </div>
                <div class="result-card">
                    <div class="result-value">156個</div>
                    <div class="result-label">総製造数</div>
                    <div class="change-positive">(+8個)</div>
                </div>
                <div class="result-card">
                    <div class="result-value">134個</div>
                    <div class="result-label">総販売数</div>
                    <div class="change-positive">(+6個)</div>
                </div>
                <div class="result-card">
                    <div class="result-value">85.9%</div>
                    <div class="result-label">製造効率</div>
                    <div class="change-positive">(+1.8%)</div>
                </div>
                <div class="result-card">
                    <div class="result-value">¥95,000</div>
                    <div class="result-label">廃棄損失</div>
                    <div class="change-negative">(+¥12,000)</div>
                </div>
                <div class="result-card">
                    <div class="result-value">5.7%</div>
                    <div class="result-label">廃棄率</div>
                    <div class="change-negative">(+0.3%)</div>
                </div>
                <div class="result-card">
                    <div class="result-value">8</div>
                    <div class="result-label">品切れ回数</div>
                    <div class="change-negative">(-3回)</div>
                </div>
                <div class="result-card">
                    <div class="result-value">96.2%</div>
                    <div class="result-label">在庫充足率</div>
                    <div class="change-positive">(+2.1%)</div>
                </div>
            </div>
            
            <div style="margin-top: 2rem;">
                <h3>📊 詳細分析</h3>
                <div class="alert alert-info">
                    <strong>総合評価:</strong> 短期間での売上向上が見込まれます。在庫回転率が改善し、品切れリスクも軽減されます。特にフルーツタルトの発注数量調整により、機会損失を防げます。
                </div>
            </div>
            
            <div style="margin-top: 1rem;">
                <button class="btn btn-success">✅ この発注で確定</button>
                <button class="btn btn-primary">📋 レポート出力</button>
                <button class="btn btn-warning">🔄 条件を変更</button>
            </div>
        </div>
        
        <!-- チャートとリアルタイム更新（仕様書SIM-001準拠） -->
        <div class="charts-container">
            <div class="chart-box">
                <h3>📊 発注構成比</h3>
                <canvas id="compositionChart" width="300" height="300"></canvas>
            </div>
            <div class="chart-box">
                <h3>📈 金額・構成比リアルタイム更新</h3>
                <table class="composition-table">
                    <thead>
                        <tr>
                            <th>カテゴリ</th>
                            <th>発注数</th>
                            <th>金額</th>
                            <th>構成比</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>ケーキ類</td>
                            <td><span id="cakeCount">110</span>個</td>
                            <td>¥<span id="cakeAmount">41,800</span></td>
                            <td><span id="cakeComposition">57.3</span>%</td>
                        </tr>
                        <tr>
                            <td>プリン類</td>
                            <td><span id="puddingCount">0</span>個</td>
                            <td>¥<span id="puddingAmount">0</span></td>
                            <td><span id="puddingComposition">0.0</span>%</td>
                        </tr>
                        <tr>
                            <td>ゼリー類</td>
                            <td><span id="jellyCount">0</span>個</td>
                            <td>¥<span id="jellyAmount">0</span></td>
                            <td><span id="jellyComposition">0.0</span>%</td>
                        </tr>
                        <tr>
                            <td>その他</td>
                            <td><span id="otherCount">0</span>個</td>
                            <td>¥<span id="otherAmount">0</span></td>
                            <td><span id="otherRealComposition">0.0</span>%</td>
                        </tr>
                        <tr style="border-top: 2px solid #2c3e50; font-weight: bold;">
                            <td>合計</td>
                            <td><span id="totalCount">110</span>個</td>
                            <td>¥<span id="totalAmount">41,800</span></td>
                            <td>100.0%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Chart.js ライブラリ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // 商品データと価格設定
        const productData = {
            'YS001': { name: 'ショートケーキ', price: 380, category: 'ケーキ' },
            'YS002': { name: 'チーズケーキ', price: 420, category: 'ケーキ' },
            'YS003': { name: 'フルーツタルト', price: 350, category: 'ケーキ' },
            'YS004': { name: 'チョコレートケーキ', price: 400, category: 'ケーキ' },
            'YS005': { name: 'モンブラン', price: 450, category: 'ケーキ' }
        };
        
        let compositionChart;
        
        // 複数日予算管理データ
        const budgetData = {
            today: { budget: 60000, current: 0 },
            tomorrow: { budget: 65000, current: 0 },
            dayAfter: { budget: 58000, current: 0 }
        };
        
        // 商品別在庫データ（自動修正用）
        const inventoryData = {
            'YS001': { currentStock: 0, avgDailySales: 30, price: 380 },
            'YS002': { currentStock: 0, avgDailySales: 20, price: 420 },
            'YS003': { currentStock: 0, avgDailySales: 15, price: 350 },
            'YS004': { currentStock: 0, avgDailySales: 25, price: 400 },
            'YS005': { currentStock: 0, avgDailySales: 12, price: 450 }
        };
        
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            initializeChart();
            updateAllCalculations();
            setupEventListeners();
            setupMultiDayBudget();
            setupInventoryForecast();
        });
        
        // チャート初期化
        function initializeChart() {
            const ctx = document.getElementById('compositionChart').getContext('2d');
            compositionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['ケーキ', 'プリン', 'ゼリー', 'その他'],
                    datasets: [{
                        data: [40, 25, 15, 20],
                        backgroundColor: ['#e74c3c', '#f39c12', '#2ecc71', '#9b59b6'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // イベントリスナー設定
        function setupEventListeners() {
            // 個別商品スライダーのイベント
            ['YS001', 'YS002', 'YS003', 'YS004', 'YS005'].forEach(productCode => {
                const slider = document.getElementById('orderSlider-' + productCode);
                if (slider) {
                    slider.addEventListener('input', function() {
                        updateProductOrder(productCode, this.value);
                    });
                }
            });
            
            // 実績入力からの同期ボタン
            const syncButton = document.getElementById('syncFromPerformance');
            if (syncButton) {
                syncButton.addEventListener('click', syncFromPerformanceData);
            }
            
            // 発注数量入力フィールドのイベント
            document.querySelectorAll('.order-input').forEach(input => {
                input.addEventListener('input', function() {
                    validateConstraints(this);
                    updateAllCalculations();
                });
            });
        }
        
        // スライダー値更新
        function updateSliderValue(category, value) {
            document.getElementById(category + 'Value').textContent = value;
            
            // 合計構成比チェック
            const total = parseInt(document.getElementById('cakeValue').textContent) +
                         parseInt(document.getElementById('puddingValue').textContent) +
                         parseInt(document.getElementById('jellyValue').textContent) +
                         parseInt(document.getElementById('otherValue').textContent);
            
            document.getElementById('totalComposition').textContent = total;
            
            const alert = document.getElementById('compositionAlert');
            if (total !== 100) {
                alert.style.display = 'inline';
            } else {
                alert.style.display = 'none';
            }
        }
        
        // 構成比チャート更新
        function updateCompositionChart() {
            const cake = parseInt(document.getElementById('cakeValue').textContent);
            const pudding = parseInt(document.getElementById('puddingValue').textContent);
            const jelly = parseInt(document.getElementById('jellyValue').textContent);
            const other = parseInt(document.getElementById('otherValue').textContent);
            
            compositionChart.data.datasets[0].data = [cake, pudding, jelly, other];
            compositionChart.update();
        }
        
        // 制約チェック
        function validateConstraints(input) {
            const value = parseInt(input.value) || 0;
            const min = parseInt(input.dataset.min) || 0;
            const step = parseInt(input.dataset.step) || 1;
            
            const row = input.closest('tr');
            const badge = row.querySelector('.constraint-badge');
            
            if (value < min) {
                badge.textContent = '最小未満';
                badge.className = 'constraint-badge constraint-error';
            } else if (value % step !== 0) {
                badge.textContent = '倍数外';
                badge.className = 'constraint-badge constraint-warning';
            } else {
                badge.textContent = 'OK';
                badge.className = 'constraint-badge constraint-ok';
            }
        }
        
        // 全体計算更新
        function updateAllCalculations() {
            let totalAmount = 0;
            let totalCount = 0;
            const categories = { 'ケーキ': { count: 0, amount: 0 }, 'プリン': { count: 0, amount: 0 }, 'ゼリー': { count: 0, amount: 0 }, 'その他': { count: 0, amount: 0 } };
            
            // 各行の計算
            document.querySelectorAll('.order-input').forEach(input => {
                const row = input.closest('tr');
                const cells = row.querySelectorAll('td');
                const productCode = cells[0].textContent;
                const category = cells[2].textContent;
                const currentOrder = parseInt(cells[3].textContent);
                const modifiedOrder = parseInt(input.value) || 0;
                const diff = modifiedOrder - currentOrder;
                
                // 差分表示
                const diffCell = cells[8];
                if (diff > 0) {
                    diffCell.textContent = '+' + diff;
                    diffCell.className = 'change-positive';
                } else if (diff < 0) {
                    diffCell.textContent = diff;
                    diffCell.className = 'change-negative';
                } else {
                    diffCell.textContent = '±0';
                    diffCell.className = '';
                }
                
                // 構成比計算（仮の金額計算）
                const amount = modifiedOrder * (productData[productCode]?.price || 350);
                totalAmount += amount;
                totalCount += modifiedOrder;
                
                // カテゴリ別集計
                if (categories[category]) {
                    categories[category].count += modifiedOrder;
                    categories[category].amount += amount;
                }
            });
            
            // 構成比の更新
            document.querySelectorAll('.composition-cell').forEach((cell, index) => {
                const row = cell.closest('tr');
                const input = row.querySelector('.order-input');
                const productCode = row.querySelector('td').textContent;
                const modifiedOrder = parseInt(input.value) || 0;
                const amount = modifiedOrder * (productData[productCode]?.price || 350);
                const composition = totalAmount > 0 ? ((amount / totalAmount) * 100).toFixed(1) : 0;
                cell.textContent = composition + '%';
            });
            
            // 予算更新
            const budget = 60000;
            const budgetPercentage = Math.min((totalAmount / budget) * 100, 100);
            document.getElementById('currentBudget').textContent = '¥' + totalAmount.toLocaleString();
            document.getElementById('budgetBar').style.width = budgetPercentage + '%';
            
            // カテゴリ別テーブル更新
            document.getElementById('cakeCount').textContent = categories['ケーキ'].count;
            document.getElementById('cakeAmount').textContent = categories['ケーキ'].amount.toLocaleString();
            document.getElementById('cakeComposition').textContent = totalAmount > 0 ? ((categories['ケーキ'].amount / totalAmount) * 100).toFixed(1) : '0.0';
            
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('totalAmount').textContent = totalAmount.toLocaleString();
            
            // 本日予算の更新
            budgetData.today.current = totalAmount;
            updateBudgetDisplay('today', totalAmount);
        }
        
        // 複数日予算管理の設定
        function setupMultiDayBudget() {
            // 予算入力フィールドのイベントリスナー
            document.getElementById('tomorrowBudgetInput').addEventListener('input', function() {
                budgetData.tomorrow.budget = parseInt(this.value) || 0;
                updateBudgetDisplay('tomorrow', budgetData.tomorrow.current);
                calculateInventoryForecast();
            });
            
            document.getElementById('dayAfterBudgetInput').addEventListener('input', function() {
                budgetData.dayAfter.budget = parseInt(this.value) || 0;
                updateBudgetDisplay('dayAfter', budgetData.dayAfter.current);
                calculateInventoryForecast();
            });
        }
        
        // 予算表示の更新
        function updateBudgetDisplay(day, currentAmount) {
            const budget = budgetData[day].budget;
            const percentage = budget > 0 ? Math.min((currentAmount / budget) * 100, 100) : 0;
            
            let budgetSpanId, barId, percentageSpanId;
            
            switch(day) {
                case 'today':
                    budgetSpanId = 'todayBudget';
                    barId = 'todayBudgetBar';
                    break;
                case 'tomorrow':
                    budgetSpanId = 'tomorrowBudget';
                    barId = 'tomorrowBudgetBar';
                    break;
                case 'dayAfter':
                    budgetSpanId = 'dayAfterBudget';
                    barId = 'dayAfterBudgetBar';
                    percentageSpanId = 'dayAfterPercentage';
                    break;
            }
            
            document.getElementById(budgetSpanId).textContent = '¥' + currentAmount.toLocaleString();
            document.getElementById(barId).style.width = percentage + '%';
            
            if (percentageSpanId) {
                document.getElementById(percentageSpanId).textContent = percentage.toFixed(1);
            }
        }
        
        // 在庫推移予測の設定
        function setupInventoryForecast() {
            // 在庫・売上予想入力のイベントリスナー
            ['remainingStock', 'tomorrowSales', 'dayAfterSales'].forEach(id => {
                document.getElementById(id).addEventListener('input', calculateInventoryForecast);
            });
        }
        
        // 在庫推移と自動修正の計算
        function calculateInventoryForecast() {
            const remainingStock = parseInt(document.getElementById('remainingStock').value) || 0;
            const tomorrowSales = parseInt(document.getElementById('tomorrowSales').value) || 100;
            const dayAfterSales = parseInt(document.getElementById('dayAfterSales').value) || 95;
            
            // 翌日の必要発注数を計算
            const tomorrowNeeded = Math.max(0, tomorrowSales - remainingStock);
            const tomorrowOrderAmount = tomorrowNeeded * 380; // 平均単価
            
            // 翌々日の在庫状況を予測
            const tomorrowEndStock = Math.max(0, remainingStock + tomorrowNeeded - tomorrowSales);
            const dayAfterNeeded = Math.max(0, dayAfterSales - tomorrowEndStock);
            
            // 予算制約を考慮した翌々日修正
            const dayAfterBudget = budgetData.dayAfter.budget;
            const maxDayAfterQuantity = Math.floor(dayAfterBudget / 380); // 平均単価で計算
            const adjustedDayAfterOrder = Math.min(dayAfterNeeded, maxDayAfterQuantity);
            const dayAfterOrderAmount = adjustedDayAfterOrder * 380;
            
            // 結果の表示
            updateBudgetDisplay('tomorrow', tomorrowOrderAmount);
            updateBudgetDisplay('dayAfter', dayAfterOrderAmount);
            
            // 自動修正結果の詳細表示
            const resultsDiv = document.getElementById('autoAdjustmentResults');
            resultsDiv.innerHTML = `
                <div style="display: grid; gap: 1rem;">
                    <div><strong>📦 翌日発注計算:</strong></div>
                    <div>・当日残在庫: ${remainingStock}個</div>
                    <div>・翌日予想売上: ${tomorrowSales}個</div>
                    <div>・翌日必要発注: ${tomorrowNeeded}個 (¥${tomorrowOrderAmount.toLocaleString()})</div>
                    
                    <div style="margin-top: 1rem;"><strong>📈 翌々日自動修正:</strong></div>
                    <div>・翌日終了予想在庫: ${tomorrowEndStock}個</div>
                    <div>・翌々日予想売上: ${dayAfterSales}個</div>
                    <div>・理論的必要数: ${dayAfterNeeded}個</div>
                    <div>・予算制約適用後: ${adjustedDayAfterOrder}個 (¥${dayAfterOrderAmount.toLocaleString()})</div>
                    
                    ${adjustedDayAfterOrder < dayAfterNeeded ? 
                        `<div style="color: #e74c3c; margin-top: 0.5rem;">⚠️ 予算制約により ${dayAfterNeeded - adjustedDayAfterOrder}個削減されました</div>` : 
                        `<div style="color: #27ae60; margin-top: 0.5rem;">✅ 予算内で必要数を確保できます</div>`
                    }
                </div>
            `;
        }
        
        // 個別商品発注数更新
        function updateProductOrder(productCode, quantity) {
            const orderValue = parseInt(quantity);
            const price = productData[productCode].price;
            const amount = orderValue * price;
            
            // 表示更新
            document.getElementById('orderValue-' + productCode).textContent = orderValue;
            document.getElementById('amount-' + productCode).textContent = amount.toLocaleString();
            
            // 合計計算の更新
            updateOrderSummary();
            updateAllCalculations();
        }
        
        // 発注サマリーの更新
        function updateOrderSummary() {
            let totalQuantity = 0;
            let totalAmount = 0;
            let totalStock = 0;
            let stockedProducts = 0;
            
            ['YS001', 'YS002', 'YS003', 'YS004', 'YS005'].forEach(productCode => {
                const orderQuantity = parseInt(document.getElementById('orderValue-' + productCode).textContent);
                const stock = parseInt(document.getElementById('stock-' + productCode).textContent);
                const price = productData[productCode].price;
                
                totalQuantity += orderQuantity;
                totalAmount += orderQuantity * price;
                totalStock += stock;
                if (stock > 0) stockedProducts++;
            });
            
            const averageStockRate = stockedProducts > 0 ? Math.round((stockedProducts / 5) * 100) : 0;
            
            document.getElementById('totalOrderQuantity').textContent = totalQuantity;
            document.getElementById('totalOrderAmount').textContent = totalAmount.toLocaleString();
            document.getElementById('averageStockRate').textContent = averageStockRate + '%';
        }
        
        // 実績入力データからの同期機能
        function syncFromPerformanceData() {
            // LocalStorageから実績入力データを取得（実際の実装では実績入力ページから取得）
            const performanceData = getPerformanceData();
            
            if (performanceData && performanceData.length > 0) {
                // 在庫データを同期
                performanceData.forEach(item => {
                    const stockElement = document.getElementById('stock-' + item.productCode);
                    if (stockElement) {
                        stockElement.textContent = item.currentStock || 0;
                        // 在庫に応じた発注数の自動調整
                        adjustOrderBasedOnStock(item.productCode, item.currentStock || 0);
                    }
                });
                
                // 同期状態の更新
                document.getElementById('syncStatus').innerHTML = 
                    `<span style="color: #27ae60;">✅ ${new Date().toLocaleTimeString()} に実績入力データと同期完了</span>`;
                
                updateOrderSummary();
            } else {
                document.getElementById('syncStatus').innerHTML = 
                    `<span style="color: #e74c3c;">❌ 実績入力データが見つかりません</span>`;
            }
        }
        
        // 在庫に応じた発注数の自動調整
        function adjustOrderBasedOnStock(productCode, currentStock) {
            const avgSales = inventoryData[productCode].avgDailySales;
            const recommendedOrder = Math.max(0, Math.round(avgSales * 1.2 - currentStock)); // 20%マージン
            
            const slider = document.getElementById('orderSlider-' + productCode);
            if (slider) {
                slider.value = Math.min(recommendedOrder, 50); // 最大50個
                updateProductOrder(productCode, slider.value);
            }
        }
        
        // 実績入力データの取得（シミュレーション用のサンプルデータ）
        function getPerformanceData() {
            // 実際の実装では実績入力ページのデータまたはAPIから取得
            return [
                { productCode: 'YS001', productName: 'ショートケーキ', currentStock: 6 },
                { productCode: 'YS002', productName: 'チーズケーキ', currentStock: 3 },
                { productCode: 'YS003', productName: 'フルーツタルト', currentStock: 0 },
                { productCode: 'YS004', productName: 'チョコレートケーキ', currentStock: 8 },
                { productCode: 'YS005', productName: 'モンブラン', currentStock: 12 }
            ];
        }
    </script>
</body>
</html>