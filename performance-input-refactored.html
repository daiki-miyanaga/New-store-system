<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´‹ç”Ÿå®Ÿç¸¾å…¥åŠ›ï¼†çŸ­æ—¥ãƒãƒ¼ãƒˆ - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ç‰ˆ</title>
    
    <!-- External stylesheets -->
    <link rel="stylesheet" href="assets/css/common.css">
    
    <!-- Page-specific styles -->
    <style>
        /* Page-specific styles that don't belong in common.css */
        .container {
            max-width: 1400px;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }
        
        .hourly-sales {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
        }
        
        .hourly-input {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .hourly-input label {
            font-size: 0.8rem;
            margin-bottom: 0.3rem;
            color: #2c3e50;
        }
        
        .hourly-input input {
            width: 60px;
            padding: 0.3rem;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.8rem;
        }
        
        .expiry-tag {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .expiry-critical {
            background: #f8d7da;
            color: #721c24;
        }
        
        .expiry-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .expiry-safe {
            background: #d4edda;
            color: #155724;
        }
        
        .validation-error {
            border: 2px solid #dc3545 !important;
            background-color: #f8d7da !important;
        }
        
        .validation-warning {
            border: 2px solid #ffc107 !important;
            background-color: #fff3cd !important;
        }
        
        .validation-success {
            border: 1px solid #28a745 !important;
        }
        
        .quick-input {
            background: #e8f5e8;
            border: 1px solid #27ae60;
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .quick-input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            align-items: end;
        }
        
        .note-section {
            margin-top: 2rem;
        }
        
        .note-item {
            background: #fff9c4;
            border-left: 4px solid #f39c12;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0 4px 4px 0;
        }
        
        .note-date {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“Š æ´‹ç”Ÿå®Ÿç¸¾å…¥åŠ›ï¼†çŸ­æ—¥ãƒãƒ¼ãƒˆ</h1>
        <a href="index.html" class="back-btn">â† ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼</a>
    </div>
    
    <div class="container">
        <!-- Quick input section -->
        <div class="form-section">
            <h2>âš¡ ã‚¯ã‚¤ãƒƒã‚¯å®Ÿç¸¾å…¥åŠ›</h2>
            <div class="quick-input">
                <div class="quick-input-grid">
                    <div class="form-group">
                        <label>æ—¥ä»˜</label>
                        <input type="date" id="quickDate" value="2024-01-15">
                    </div>
                    <div class="form-group">
                        <label>å•†å“ã‚³ãƒ¼ãƒ‰</label>
                        <input type="text" id="quickProductCode" placeholder="ä¾‹: YS001">
                    </div>
                    <div class="form-group">
                        <label>å£²ä¸Šæ•°é‡</label>
                        <input type="number" id="quickSalesQty" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label>å˜ä¾¡</label>
                        <input type="number" id="quickUnitPrice" placeholder="0" min="0">
                    </div>
                    <div class="form-group">
                        <label></label>
                        <button class="btn btn-success" id="addQuickEntry">è¿½åŠ </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Header information -->
        <div class="form-section">
            <h2>ğŸ“… æ—¥æ¬¡æƒ…å ±è¨­å®š</h2>
            <form id="dailyInfoForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>æ—¥ä»˜</label>
                        <input type="date" id="businessDate" value="2024-01-15" required>
                    </div>
                    <div class="form-group">
                        <label>å®¢æ•°</label>
                        <input type="number" id="customerCount" placeholder="60" value="60" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>å¤©æ°—</label>
                        <select id="weather" required>
                            <option value="æ™´ã‚Œ">æ™´ã‚Œ</option>
                            <option value="æ›‡ã‚Š">æ›‡ã‚Š</option>
                            <option value="é›¨">é›¨</option>
                            <option value="é›ª">é›ª</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>æ°—æ¸©ï¼ˆâ„ƒï¼‰</label>
                        <input type="number" id="temperature" placeholder="15" value="15" min="-20" max="50">
                    </div>
                    <div class="form-group">
                        <label>ç‰¹æ‹›ä¼šãƒ»ã‚¤ãƒ™ãƒ³ãƒˆ</label>
                        <select id="eventType">
                            <option value="ãªã—">ãªã—</option>
                            <option value="ç‰¹æ‹›ä¼š">ç‰¹æ‹›ä¼š</option>
                            <option value="ã‚»ãƒ¼ãƒ«">ã‚»ãƒ¼ãƒ«</option>
                            <option value="æ–°å•†å“ç™ºå£²">æ–°å•†å“ç™ºå£²</option>
                            <option value="ç«¶åˆå‚¬äº‹">ç«¶åˆå‚¬äº‹</option>
                        </select>
                    </div>
                </div>
            </form>
        </div>
        
        <!-- Product performance input table -->
        <div class="form-section">
            <h2>ğŸ“ å•†å“åˆ¥å®Ÿç¸¾å…¥åŠ›</h2>
            <div class="mb-1">
                <button class="btn btn-success" id="addProductBtn">â• å•†å“è¿½åŠ </button>
                <button class="btn btn-primary" id="applyTemplateBtn">ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé©ç”¨</button>
                <button class="btn btn-primary" id="autoCalculateBtn">ğŸ”„ è‡ªå‹•è¨ˆç®—</button>
            </div>
            
            <!-- Validation summary container -->
            <div id="validationSummary"></div>
            
            <div class="table-container">
                <table class="data-table" id="productTable">
                    <thead>
                        <tr>
                            <th>å•†å“ã‚³ãƒ¼ãƒ‰</th>
                            <th>å•†å“å</th>
                            <th>å˜ä¾¡</th>
                            <th>ã‚«ãƒ†ã‚´ãƒª</th>
                            <th>å‰æ—¥æ®‹</th>
                            <th>å½“æ—¥å…¥åº«</th>
                            <th>ç§»å‹•</th>
                            <th>è²©å£²æ•°</th>
                            <th>ãƒ­ã‚¹æ•°</th>
                            <th>å½“æ—¥åœ¨åº«<br><small>(è‡ªå‹•)</small></th>
                            <th>é–‰åº—æ™‚åœ¨åº«</th>
                            <th>ç‰¹æ³¨</th>
                            <th>å®Œå£²æ™‚é–“</th>
                            <th>å£²ä¸Šé¡</th>
                            <th>æ§‹æˆæ¯”</th>
                            <th>æ¶ˆè²»æœŸé™</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="productTableBody">
                        <!-- Product rows will be dynamically generated -->
                    </tbody>
                </table>
            </div>
            
            <div id="productSummary" class="mt-1" style="padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                <strong>åˆè¨ˆæƒ…å ±:</strong> <span id="summaryText">è¨ˆç®—ä¸­...</span>
            </div>
        </div>
        
        <!-- Hourly sales input -->
        <div class="form-section">
            <h2>ğŸ• æ™‚é–“å¸¯åˆ¥å£²ä¸Šå…¥åŠ›</h2>
            <div class="mb-1">
                <button class="btn btn-success" id="addHourlyBtn">â• æ™‚é–“è¿½åŠ </button>
                <button class="btn btn-primary" id="showChartBtn">ğŸ“ˆ ã‚°ãƒ©ãƒ•è¡¨ç¤º</button>
            </div>
            <div class="table-container">
                <table class="data-table" id="hourlyTable">
                    <thead>
                        <tr>
                            <th>æ™‚é–“</th>
                            <th>å£²ä¸Šé¡</th>
                            <th>æ§‹æˆæ¯”</th>
                            <th>ç´¯è¨ˆ</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="hourlyTableBody">
                        <!-- Hourly data rows will be dynamically generated -->
                    </tbody>
                </table>
            </div>
            <div id="hourlySummary" class="mt-1" style="padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                <strong>æ™‚é–“å¸¯åˆè¨ˆ:</strong> <span id="hourlyTotalText">Â¥0 | ãƒ”ãƒ¼ã‚¯æ™‚é–“: ãªã—</span>
            </div>
        </div>
        
        <!-- Daily notes -->
        <div class="form-section">
            <h2>ğŸ“– çŸ­æ—¥ãƒãƒ¼ãƒˆ</h2>
            <div class="form-group">
                <label>ä»Šæ—¥ã®ãƒ¡ãƒ¢ãƒ»æ°—ã¥ã</label>
                <textarea id="dailyNote" placeholder="æœ¬æ—¥ã®å£²ä¸ŠçŠ¶æ³ã€å®¢å±¤ã®å¤‰åŒ–ã€å•†å“ã®å‹•å‘ãªã©ã€æ°—ã¥ã„ãŸã“ã¨ã‚’è¨˜éŒ²ã—ã¦ãã ã•ã„" rows="4"></textarea>
            </div>
            
            <div class="note-section">
                <h3>éå»ã®ãƒãƒ¼ãƒˆ</h3>
                <div id="previousNotes">
                    <!-- Previous notes will be loaded here -->
                </div>
            </div>
        </div>
        
        <!-- Action buttons -->
        <div class="text-center mb-2">
            <button class="btn btn-success" id="saveDataBtn">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜</button>
            <button class="btn btn-primary" id="generateReportBtn">ğŸ“Š æ—¥å ±ã‚’ç”Ÿæˆ</button>
            <button class="btn btn-primary" id="showGraphsBtn">ğŸ“ˆ ã‚°ãƒ©ãƒ•è¡¨ç¤º</button>
        </div>
    </div>
    
    <!-- External JavaScript libraries -->
    <script src="assets/js/common-utils.js"></script>
    <script src="assets/js/form-validator.js"></script>
    
    <!-- Page-specific JavaScript -->
    <script>
        // Page-specific JavaScript using the refactored utilities
        class PerformanceInputManager {
            constructor() {
                this.validator = new FormValidator();
                this.productData = [];
                this.hourlyData = [];
                
                this.initializeData();
                this.setupEventListeners();
                this.setupValidation();
            }

            initializeData() {
                // Initialize with sample data
                this.productData = [
                    {
                        code: 'YS001',
                        name: 'ã‚·ãƒ§ãƒ¼ãƒˆã‚±ãƒ¼ã‚­',
                        price: 380,
                        category: 'ã‚±ãƒ¼ã‚­',
                        prevStock: 8,
                        delivery: 35,
                        movement: 0,
                        sales: 35,
                        waste: 2,
                        eodStock: 6,
                        special: 3,
                        soldoutTime: '18:30'
                    },
                    {
                        code: 'YS002',
                        name: 'ãƒãƒ¼ã‚ºã‚±ãƒ¼ã‚­',
                        price: 420,
                        category: 'ã‚±ãƒ¼ã‚­',
                        prevStock: 5,
                        delivery: 25,
                        movement: 2,
                        sales: 28,
                        waste: 1,
                        eodStock: 3,
                        special: 1,
                        soldoutTime: '19:15'
                    }
                ];

                this.hourlyData = [
                    { time: '09:00-10:00', amount: 3200 },
                    { time: '10:00-11:00', amount: 4800 },
                    { time: '11:00-12:00', amount: 7200 },
                    { time: '14:00-15:00', amount: 9600 }
                ];

                this.renderTables();
            }

            setupEventListeners() {
                const { EventUtils } = window.CommonUtils;

                // Product table events
                EventUtils.addListener('addProductBtn', 'click', () => this.addProductRow());
                EventUtils.addListener('autoCalculateBtn', 'click', () => this.calculateAll());
                
                // Hourly table events
                EventUtils.addListener('addHourlyBtn', 'click', () => this.addHourlyRow());
                
                // Quick input events
                EventUtils.addListener('addQuickEntry', 'click', () => this.addQuickEntry());
                
                // Save and report events
                EventUtils.addListener('saveDataBtn', 'click', () => this.saveData());
                EventUtils.addListener('generateReportBtn', 'click', () => this.generateReport());
                
                // Table change events (delegated)
                document.getElementById('productTableBody').addEventListener('input', (e) => {
                    if (e.target.tagName === 'INPUT') {
                        this.handleProductInputChange(e.target);
                    }
                });

                document.getElementById('hourlyTableBody').addEventListener('input', (e) => {
                    if (e.target.tagName === 'INPUT') {
                        this.calculateHourlyTotals();
                    }
                });
            }

            setupValidation() {
                // Define validation rules for the form
                const fieldRules = {
                    businessDate: ['required'],
                    customerCount: ['required', 'numeric', 'range'],
                    temperature: ['numeric', 'range']
                };

                // Setup real-time validation
                this.validator.setupRealTimeValidation('dailyInfoForm', fieldRules, {
                    context: { min: 0, max: 999 },
                    debounceDelay: 300
                });
            }

            renderTables() {
                this.renderProductTable();
                this.renderHourlyTable();
                this.calculateAll();
            }

            renderProductTable() {
                const tbody = document.getElementById('productTableBody');
                tbody.innerHTML = '';

                this.productData.forEach((product, index) => {
                    const row = this.createProductRow(product, index);
                    tbody.appendChild(row);
                });
            }

            createProductRow(product, index) {
                const { CalculationUtils } = window.CommonUtils;
                
                const row = document.createElement('tr');
                row.dataset.index = index;

                const currentStock = CalculationUtils.calculateCurrentStock(
                    product.prevStock, product.delivery, product.movement,
                    product.sales, product.waste
                );

                const salesAmount = product.sales * product.price;

                row.innerHTML = `
                    <td><input type="text" class="product-input" data-field="code" value="${product.code}" style="width: 80px;"></td>
                    <td><input type="text" class="product-input" data-field="name" value="${product.name}" style="width: 120px;"></td>
                    <td><input type="number" class="product-input" data-field="price" value="${product.price}" style="width: 80px;"></td>
                    <td>
                        <select class="product-input" data-field="category" style="width: 80px;">
                            <option value="ã‚±ãƒ¼ã‚­" ${product.category === 'ã‚±ãƒ¼ã‚­' ? 'selected' : ''}>ã‚±ãƒ¼ã‚­</option>
                            <option value="ãƒ—ãƒªãƒ³" ${product.category === 'ãƒ—ãƒªãƒ³' ? 'selected' : ''}>ãƒ—ãƒªãƒ³</option>
                            <option value="ã‚¼ãƒªãƒ¼" ${product.category === 'ã‚¼ãƒªãƒ¼' ? 'selected' : ''}>ã‚¼ãƒªãƒ¼</option>
                        </select>
                    </td>
                    <td><input type="number" class="product-input" data-field="prevStock" value="${product.prevStock}" style="width: 60px;"></td>
                    <td><input type="number" class="product-input" data-field="delivery" value="${product.delivery}" style="width: 60px;"></td>
                    <td><input type="number" class="product-input" data-field="movement" value="${product.movement}" style="width: 60px;"></td>
                    <td><input type="number" class="product-input" data-field="sales" value="${product.sales}" style="width: 60px;"></td>
                    <td><input type="number" class="product-input" data-field="waste" value="${product.waste}" style="width: 60px;"></td>
                    <td class="calculated-field" style="background: #f0f0f0;">${currentStock}</td>
                    <td><input type="number" class="product-input" data-field="eodStock" value="${product.eodStock}" style="width: 60px;"></td>
                    <td><input type="number" class="product-input" data-field="special" value="${product.special}" style="width: 60px;"></td>
                    <td><input type="time" class="product-input" data-field="soldoutTime" value="${product.soldoutTime}" style="width: 80px;"></td>
                    <td class="calculated-field" style="background: #f0f0f0;">${CalculationUtils.formatCurrency(salesAmount)}</td>
                    <td class="calculated-field composition-cell" style="background: #f0f0f0;">0.0%</td>
                    <td><span class="expiry-tag expiry-warning">æ˜æ—¥ã¾ã§</span></td>
                    <td>
                        <button class="btn btn-primary copy-btn" style="padding: 0.2rem 0.4rem; font-size: 0.7rem;">è¤‡è£½</button>
                        <button class="btn btn-warning delete-btn" style="padding: 0.2rem 0.4rem; font-size: 0.7rem;">å‰Šé™¤</button>
                    </td>
                `;

                // Add event listeners for row buttons
                row.querySelector('.copy-btn').addEventListener('click', () => this.copyProductRow(index));
                row.querySelector('.delete-btn').addEventListener('click', () => this.deleteProductRow(index));

                return row;
            }

            renderHourlyTable() {
                const tbody = document.getElementById('hourlyTableBody');
                tbody.innerHTML = '';

                this.hourlyData.forEach((hourly, index) => {
                    const row = this.createHourlyRow(hourly, index);
                    tbody.appendChild(row);
                });
            }

            createHourlyRow(hourly, index) {
                const row = document.createElement('tr');
                row.dataset.index = index;

                row.innerHTML = `
                    <td>${hourly.time}</td>
                    <td><input type="number" class="hourly-input" data-field="amount" value="${hourly.amount}" style="width: 100px;"></td>
                    <td class="calculated-field composition-cell" style="background: #f0f0f0;">0.0%</td>
                    <td class="calculated-field cumulative-cell" style="background: #f0f0f0;">Â¥0</td>
                    <td><button class="btn btn-warning delete-hourly-btn" style="padding: 0.2rem 0.4rem; font-size: 0.7rem;">å‰Šé™¤</button></td>
                `;

                // Add delete event listener
                row.querySelector('.delete-hourly-btn').addEventListener('click', () => this.deleteHourlyRow(index));

                return row;
            }

            handleProductInputChange(input) {
                const { ValidationUtils, CalculationUtils } = window.CommonUtils;
                
                const row = input.closest('tr');
                const index = parseInt(row.dataset.index);
                const field = input.dataset.field;
                const value = input.type === 'number' ? parseInt(input.value) || 0 : input.value;

                // Update data model
                if (this.productData[index]) {
                    this.productData[index][field] = value;
                }

                // Perform field-specific validation
                this.validateProductField(input, row, index);
                
                // Recalculate dependent fields
                this.updateCalculatedFields(row, index);
                this.calculateProductTotals();
            }

            validateProductField(input, row, index) {
                const { ValidationUtils } = window.CommonUtils;
                const field = input.dataset.field;
                const product = this.productData[index];

                if (!product) return;

                let validationResult = { isValid: true };

                switch (field) {
                    case 'waste':
                        const totalHandled = product.sales + product.waste;
                        validationResult = ValidationUtils.validateLossRate(product.waste, totalHandled);
                        break;
                        
                    case 'soldoutTime':
                        validationResult = ValidationUtils.validateTimeFormat(input.value);
                        break;
                        
                    case 'sales':
                    case 'delivery':
                    case 'movement':
                        // Check if stock will go negative
                        const calculatedStock = CalculationUtils.calculateCurrentStock(
                            product.prevStock, product.delivery, product.movement,
                            product.sales, product.waste
                        );
                        if (calculatedStock < 0) {
                            validationResult = {
                                isValid: false,
                                level: 'error',
                                message: 'åœ¨åº«ãŒãƒã‚¤ãƒŠã‚¹ã«ãªã£ã¦ã„ã¾ã™'
                            };
                        }
                        break;
                }

                // Apply validation styling
                input.classList.remove('validation-error', 'validation-warning', 'validation-success');
                if (!validationResult.isValid) {
                    const className = validationResult.level === 'error' ? 'validation-error' : 'validation-warning';
                    input.classList.add(className);
                } else {
                    input.classList.add('validation-success');
                }
            }

            updateCalculatedFields(row, index) {
                const { CalculationUtils } = window.CommonUtils;
                const product = this.productData[index];
                
                if (!product) return;

                // Update current stock
                const currentStock = CalculationUtils.calculateCurrentStock(
                    product.prevStock, product.delivery, product.movement,
                    product.sales, product.waste
                );
                
                const currentStockCell = row.querySelector('.calculated-field:first-of-type');
                if (currentStockCell) {
                    currentStockCell.textContent = currentStock;
                }

                // Update sales amount
                const salesAmount = product.sales * product.price;
                const salesAmountCells = row.querySelectorAll('.calculated-field');
                if (salesAmountCells.length > 1) {
                    salesAmountCells[1].textContent = CalculationUtils.formatCurrency(salesAmount);
                }
            }

            calculateAll() {
                this.calculateProductTotals();
                this.calculateHourlyTotals();
                this.updateValidationSummary();
            }

            calculateProductTotals() {
                const { CalculationUtils, DataUtils } = window.CommonUtils;
                
                let totalSales = 0;
                let totalItems = 0;
                let totalWaste = 0;

                // Calculate totals and update composition percentages
                this.productData.forEach((product) => {
                    const salesAmount = product.sales * product.price;
                    totalSales += salesAmount;
                    totalItems += product.sales;
                    totalWaste += product.waste;
                });

                // Update composition percentages
                const compositionCells = document.querySelectorAll('.composition-cell');
                this.productData.forEach((product, index) => {
                    const salesAmount = product.sales * product.price;
                    const composition = CalculationUtils.calculateComposition(salesAmount, totalSales);
                    if (compositionCells[index]) {
                        compositionCells[index].textContent = composition + '%';
                    }
                });

                // Update summary
                const wasteRate = totalItems + totalWaste > 0 ? 
                    ((totalWaste / (totalItems + totalWaste)) * 100).toFixed(1) : '0.0';

                const summaryText = `å£²ä¸Šé¡: ${CalculationUtils.formatCurrency(totalSales)} | ç·è²©å£²æ•°: ${totalItems}å€‹ | ç·ãƒ­ã‚¹æ•°: ${totalWaste}å€‹ | ãƒ­ã‚¹ç‡: ${wasteRate}%`;
                
                document.getElementById('summaryText').textContent = summaryText;
            }

            calculateHourlyTotals() {
                const { CalculationUtils } = window.CommonUtils;
                
                let total = 0;
                let peakAmount = 0;
                let peakTime = '';

                // Calculate totals from DOM inputs
                const inputs = document.querySelectorAll('#hourlyTableBody input[data-field="amount"]');
                const amounts = Array.from(inputs).map(input => parseInt(input.value) || 0);
                
                amounts.forEach(amount => total += amount);

                // Update composition and cumulative cells
                let cumulative = 0;
                const rows = document.querySelectorAll('#hourlyTableBody tr');
                
                rows.forEach((row, index) => {
                    const amount = amounts[index] || 0;
                    cumulative += amount;

                    // Track peak time
                    if (amount > peakAmount) {
                        peakAmount = amount;
                        peakTime = row.cells[0].textContent;
                    }

                    // Update composition
                    const compositionCell = row.querySelector('.composition-cell');
                    if (compositionCell) {
                        const composition = CalculationUtils.calculateComposition(amount, total);
                        compositionCell.textContent = composition + '%';
                    }

                    // Update cumulative
                    const cumulativeCell = row.querySelector('.cumulative-cell');
                    if (cumulativeCell) {
                        cumulativeCell.textContent = CalculationUtils.formatCurrency(cumulative);
                    }
                });

                // Update summary
                const summaryText = `${CalculationUtils.formatCurrency(total)} | ãƒ”ãƒ¼ã‚¯æ™‚é–“: ${peakTime} (${CalculationUtils.formatCurrency(peakAmount)})`;
                document.getElementById('hourlyTotalText').textContent = summaryText;
            }

            updateValidationSummary() {
                // Collect all validation results
                const errors = [];
                const warnings = [];

                // Check product data for validation issues
                this.productData.forEach((product, index) => {
                    const { ValidationUtils } = window.CommonUtils;
                    
                    // Loss rate validation
                    const lossRateResult = ValidationUtils.validateLossRate(product.waste, product.sales + product.waste);
                    if (!lossRateResult.isValid) {
                        const entry = { field: `${product.name} ãƒ­ã‚¹ç‡`, message: lossRateResult.message, level: lossRateResult.level };
                        if (lossRateResult.level === 'error') {
                            errors.push(entry);
                        } else {
                            warnings.push(entry);
                        }
                    }

                    // Time format validation
                    const timeResult = ValidationUtils.validateTimeFormat(product.soldoutTime);
                    if (!timeResult.isValid) {
                        errors.push({ field: `${product.name} å®Œå£²æ™‚é–“`, message: timeResult.message, level: 'error' });
                    }
                });

                // Create validation summary
                this.displayValidationSummary(errors, warnings);
            }

            displayValidationSummary(errors, warnings) {
                const { AlertUtils } = window.CommonUtils;
                const container = document.getElementById('validationSummary');
                
                AlertUtils.clearAlerts('validationSummary');

                if (errors.length === 0 && warnings.length === 0) {
                    AlertUtils.showAlert('validationSummary', 'success', 'âœ“ æ¤œè¨¼å®Œäº†', 'ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã§ã™ã€‚');
                    return;
                }

                if (errors.length > 0) {
                    AlertUtils.showAlert('validationSummary', 'error', 'ğŸš¨ å…¥åŠ›ã‚¨ãƒ©ãƒ¼', `${errors.length}ä»¶ã®ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™ã€‚`);
                }

                if (warnings.length > 0) {
                    AlertUtils.showAlert('validationSummary', 'warning', 'âš ï¸ æ³¨æ„äº‹é …', `${warnings.length}ä»¶ã®è­¦å‘ŠãŒã‚ã‚Šã¾ã™ã€‚`);
                }
            }

            addProductRow() {
                const newProduct = {
                    code: '',
                    name: '',
                    price: 0,
                    category: 'ã‚±ãƒ¼ã‚­',
                    prevStock: 0,
                    delivery: 0,
                    movement: 0,
                    sales: 0,
                    waste: 0,
                    eodStock: 0,
                    special: 0,
                    soldoutTime: ''
                };

                this.productData.push(newProduct);
                const index = this.productData.length - 1;
                
                const tbody = document.getElementById('productTableBody');
                const row = this.createProductRow(newProduct, index);
                tbody.appendChild(row);
                
                // Focus on the first input of the new row
                const firstInput = row.querySelector('input');
                if (firstInput) {
                    firstInput.focus();
                }
            }

            copyProductRow(index) {
                const originalProduct = this.productData[index];
                const copiedProduct = { ...originalProduct };
                copiedProduct.code = originalProduct.code + '_copy';
                copiedProduct.name = originalProduct.name + ' (ã‚³ãƒ”ãƒ¼)';
                
                this.productData.push(copiedProduct);
                this.renderProductTable();
            }

            deleteProductRow(index) {
                if (this.productData.length <= 1) {
                    alert('æœ€ä½1ã¤ã®å•†å“ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™ã€‚');
                    return;
                }
                
                this.productData.splice(index, 1);
                this.renderProductTable();
                this.calculateAll();
            }

            addHourlyRow() {
                const timeSlots = [
                    '08:00-09:00', '09:00-10:00', '10:00-11:00', '11:00-12:00',
                    '12:00-13:00', '13:00-14:00', '14:00-15:00', '15:00-16:00',
                    '16:00-17:00', '17:00-18:00', '18:00-19:00', '19:00-20:00'
                ];
                
                // Find next available time slot
                const usedTimes = this.hourlyData.map(h => h.time);
                const availableTime = timeSlots.find(slot => !usedTimes.includes(slot)) || 'ã‚«ã‚¹ã‚¿ãƒ æ™‚é–“';
                
                const newHourly = {
                    time: availableTime,
                    amount: 0
                };
                
                this.hourlyData.push(newHourly);
                this.renderHourlyTable();
            }

            deleteHourlyRow(index) {
                this.hourlyData.splice(index, 1);
                this.renderHourlyTable();
                this.calculateHourlyTotals();
            }

            addQuickEntry() {
                const { FormUtils } = window.CommonUtils;
                
                const code = FormUtils.getTextValue('quickProductCode');
                const qty = FormUtils.getNumericValue('quickSalesQty');
                const price = FormUtils.getNumericValue('quickUnitPrice');
                
                if (!code || qty === 0 || price === 0) {
                    alert('å•†å“ã‚³ãƒ¼ãƒ‰ã€æ•°é‡ã€å˜ä¾¡ã‚’ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
                
                // Find existing product or create new
                const existingIndex = this.productData.findIndex(p => p.code === code);
                
                if (existingIndex >= 0) {
                    this.productData[existingIndex].sales += qty;
                    this.productData[existingIndex].price = price;
                } else {
                    const newProduct = {
                        code: code,
                        name: 'å•†å“åã‚’å…¥åŠ›',
                        price: price,
                        category: 'ã‚±ãƒ¼ã‚­',
                        prevStock: 0,
                        delivery: qty,
                        movement: 0,
                        sales: qty,
                        waste: 0,
                        eodStock: 0,
                        special: 0,
                        soldoutTime: ''
                    };
                    this.productData.push(newProduct);
                }
                
                // Clear quick input fields
                FormUtils.setInputValue('quickProductCode', '');
                FormUtils.setInputValue('quickSalesQty', '');
                FormUtils.setInputValue('quickUnitPrice', '');
                
                this.renderProductTable();
                this.calculateAll();
                
                alert('ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ›ãŒå®Œäº†ã—ã¾ã—ãŸã€‚');
            }

            saveData() {
                // Validate form first
                const formValidation = this.validator.validateForm('dailyInfoForm', {
                    businessDate: ['required'],
                    customerCount: ['required', 'numeric'],
                    temperature: ['numeric']
                });

                if (!formValidation.isValid) {
                    alert('å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã«ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™ã€‚ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                // Save data (in real implementation, this would be an API call)
                const saveData = {
                    date: document.getElementById('businessDate').value,
                    customerCount: parseInt(document.getElementById('customerCount').value),
                    weather: document.getElementById('weather').value,
                    temperature: parseInt(document.getElementById('temperature').value),
                    eventType: document.getElementById('eventType').value,
                    products: this.productData,
                    hourly: this.hourlyData,
                    note: document.getElementById('dailyNote').value
                };

                // Simulate save
                console.log('Saving data:', saveData);
                alert('ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚');
            }

            generateReport() {
                // Generate a summary report
                const { CalculationUtils } = window.CommonUtils;
                
                const totalSales = this.productData.reduce((sum, p) => sum + (p.sales * p.price), 0);
                const totalWaste = this.productData.reduce((sum, p) => sum + p.waste, 0);
                const totalSalesQty = this.productData.reduce((sum, p) => sum + p.sales, 0);
                
                const report = `
                    æ—¥å ± - ${document.getElementById('businessDate').value}
                    
                    â–  åŸºæœ¬æƒ…å ±
                    å®¢æ•°: ${document.getElementById('customerCount').value}å
                    å¤©æ°—: ${document.getElementById('weather').value}
                    æ°—æ¸©: ${document.getElementById('temperature').value}â„ƒ
                    
                    â–  å£²ä¸Šå®Ÿç¸¾
                    ç·å£²ä¸Šé¡: ${CalculationUtils.formatCurrency(totalSales)}
                    è²©å£²æ•°é‡: ${totalSalesQty}å€‹
                    ãƒ­ã‚¹æ•°é‡: ${totalWaste}å€‹
                    ãƒ­ã‚¹ç‡: ${totalSalesQty + totalWaste > 0 ? ((totalWaste / (totalSalesQty + totalWaste)) * 100).toFixed(1) : 0}%
                    
                    â–  å•†å“åˆ¥å®Ÿç¸¾
                    ${this.productData.map(p => 
                        `${p.name}: ${p.sales}å€‹ (${CalculationUtils.formatCurrency(p.sales * p.price)})`
                    ).join('\n')}
                `;
                
                // In real implementation, this would generate a formatted report
                alert(report);
            }
        }

        // Initialize the application when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new PerformanceInputManager();
        });
    </script>
</body>
</html>